machine:
  node:
    version: 4.6.0
  services:
    - docker
  environment:
    PACTBROKERURL: 'http://54.197.31.162:80/'
    MAPMAKERURL: 'http://54.197.31.162:3000/'

dependencies:
  post:
    - npm install -g cypress-cli

test:
  override:
    - npm run test:unit
    - npm run test:unit-int
    - npm run test:web
  post:
    - docker build -t $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/front:$CIRCLE_SHA1 .
    - docker run -d -p 2000:2000 -e MAPMAKERURL=$MAPMAKERURL --name front $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/front:$CIRCLE_SHA1; sleep 10
    - curl -sSf http://localhost:2000 > /dev/null
    - npm run publish-pacts

deployment:
  prod:
    branch: master
    commands:
      - ./deploy.sh